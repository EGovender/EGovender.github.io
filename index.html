<!DOCTYPE html>
<meta charset="utf-8">
<style>
h1{
    font-family: Arial;
    font-weight: normal;
    color: white;
    font-size: 3.5em;
}
h2{
    font-family:Arial;
    font-weight: normal;
    color: Black;
    font-size: 2.2em;
}
body {
   font-family:Arial;
   font-size: 0.8em;
}
.country {
  fill: #32aeb3;
  stroke: white;
  stroke-width: 0.6px;
  stroke-linecap: round;
  stroke-linejoin: round;
  vector-effect: non-scaling-stroke;
 
}

.border {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
  stroke-linecap: round;
}

.bubble {
	fill: #ffff30; stroke:#ffff7f;
  stroke-width: 0.5px;
  stroke-linecap: round;
  stroke-linejoin: round;
  vector-effect: non-scaling-stroke;
}
.bubble1 {
  fill: #ffd907; stroke:#d8b429;
  stroke-width: 1px;
  stroke-linecap: round;
  stroke-linejoin: round;
  vector-effect: non-scaling-stroke;
  cursor: pointer;
}
.svg {
	background: black;
	margin-left:auto; 
	margin-right:auto; 
	display:block;
	align: center;
	width:100%;
	height:100%;
}

.selected {
	fill: #ffd907;
}

.states path {
		stroke-width: 1px;
		stroke: white;
		fill: #DBDBDB;
		cursor: pointer;
}
.arcs {
	  stroke-width: 0.3px;
	  stroke: tomato;
	  pointer-events: none;
	  fill: none;
}

.line {
	  stroke-width: 0.3px;
	  stroke: tomato;
	  
	  
}
.font-weight-bold {
  font-weight: 700 !important;
}
.commodityButton {
  font-family:Arial;
  font-color: black;
  font-weight: 700;
  color: #28a745;
  border-color: #6f42c1;
  cursor:pointer; font-family:Arial; font-size: 14px;
  width="80%";
}

.commodityButton:hover {
  color: #fff;
  background-color: #28a745;
  border-color: #6f42c1;
}

.commodityLabel, .port-label  { 
 font-family:Arial;
   font-color: black;
  cursor:pointer;  font-size: 0.9em;
 
}

.countryLabel { 
   font-color: black;
    font-family:Arial; font-size: 9px; 
}

.annotationButton, .annotationLabel { 
  font-color: black;
  background-color: white;
  border-color:red;
  cursor:pointer;  font-family:Arial; font-size: 9px; 
}



.route { fill: none; stroke: orangered; stroke-width: 0.8px; }
.port { fill: #8c6bb1; stroke:#084081; stroke-width: 2px; }	
.source-port { fill: #fdae6b; stroke:#d94801; stroke-width: 2px; }

.country-on{
  fill: #4B5358;   /* highlight colour for selected country */
}

div{
	width:100%;
	height:100%;
}
div.tooltip {   
  position: absolute;           
  text-align: center;           
  width: 100px;                  
  height: 100px;                 
  padding: 4px;    
  font-family:Arial;  
  font: 12px ;        
  background: white;   
  border: 0px;      
  border-radius: 5px;           
  pointer-events: none;  
  font-size: 1.2em;  
}


.nav-link {
  display: block;
  padding: 0.5rem 1rem;
}

.nav-link:focus, .nav-link:hover {
  text-decoration: none;
}

.nav-link.disabled {
  color: #868e96;
}

.commodityButton:hover {
  stroke: #000;
  stroke-width: 1.5px;
  fill: #ffd907;
  background-color: #e2e6ea;
  border-color: #dae0e5;
 
}

div.category {
    -moz-border-radius: 8px;
   
    background: white;
    overflow: hidden;
    width: 500px;
    text-align:left;
    border:1px dashed blue;
	align: left; 
	 font-size: 0.9em;  
	 line-height: 1.5;
	  font-family:Arial;  
	  padding: 5px; 
}
</style>
<body align="centre">
<script src="//d3js.org/d3.v4.min.js" charset="utf-8"></script>

<div align="center">
	<div align="center" style="background-color:#32aeb3;"><h1>US Visa Applications</h1></div>
	<div align="center" valign="top">
		<table valign="top">
			<tr>
				<td><input class="nav-link" type="button" name="b3" value="About the Visualization" onclick="location.href='https://egovender.github.io/About.html'"></td>
				<td><input class="nav-link" type="button" name="b1" value="Slide 1" disabled="true" onclick="location.href='https://egovender.github.io/index.html'"></td>
				<td><input class="nav-link" type="button" name="b2" value="Slide 2" onclick="location.href='https://egovender.github.io/barchart.html'"></td>
				<td><input class="nav-link" type="button" name="b3" value="Slide 3" onclick="location.href='https://egovender.github.io/bubble.html'"></td>
			</tr>
			
		</table>
	</div>
</div> 
<div align="center"><h2>Top 20 Countries of Applicants</div>
<table width="100%" height="100%"  align="centre" valign="top">
	 
	<tr>
		<td width="50%" height="100%" align="centre" valign="top">
			
			<div  align="centre" valign="top">
				<svg width="1100" height="1300" name="map" id="map"></svg>
			</div>
		</td>
		 <td><div class="category"   align="left" valign="top">This visualization is designed to provide insight into the location of visa applicants in the US. Select a country to view their top destinatations in the US.</div>
			<div class="category" align="left" valign="top">Countries Ranked by Application Count<br>1. INDIA<br>2. CHINA<br>3. S-KOREA<br>4. CANADA<br>5. MEXICO<br>6.PHILIPPINES<br>7. UK<br>8. TAIWAN<br>9. PAKISTAN<br>10. FRANCE<br>11. NEPAL<br>12. JAPAN<br>13. BRAZIL<br>14. VENEZUELA<br>15. TURKEY<br>16. RUSSIA<br>17. GERMANY<br>18. IRAN<br>19. VIETNAM<br>20. ITALY
			</div>
			
		 </td>
	</tr>
</table>
 


<script>

var margin = {top:10, left:10, right: 10, bottom:10},
	height = 800-margin.top-margin.bottom,
	width=	1200-margin.left-margin.right,
    active = d3.select(null);
    active = d3.select(null);

 
var sf = [-110.484246 ,39.0119];

var zoom = d3.zoom()
    .scaleExtent([1.7, 1.7])
    .on("zoom", zoomed);

var projection = d3.geoMercator()
	.translate([width/2, height/2 ])
	.scale(130)
	
var sfx =projection(sf)[0];	
var sfy =projection(sf)[1];	
 		
var svg = d3.select("#map")
			.append("svg")
			.attr("height", height+margin.top+margin.bottom)
			.attr("width", width+margin.left+margin.right)
			.attr("class","svg")
			.append('g')
			.attr("transform","translate(" + margin.left + "," + margin.top + ")");
			

     		
 
// Create a few groups to layer elements correctly
var g1 = svg.append("g") ;
var g2 = svg.append("g"); 
var g3 = svg.append("g"); 
var g4 = svg.append("g"); 
var g5 = svg.append("g");
var g6 = svg.append("g");
var defs = svg.append("defs");

var gradient = defs.append("linearGradient")
   .attr("id", "svgGradient")
   .attr("x1", "0%")
   .attr("x2", "100%")
   .attr("y1", "0%")
   .attr("y2", "100%");

gradient.append("stop")
   .attr('class', 'start')
   .attr("offset", "0%")
   .attr("stop-color", "red")
   .attr("stop-opacity", 1);

gradient.append("stop")
   .attr('class', 'end')
   .attr("offset", "100%")
   .attr("stop-color", "blue")
   .attr("stop-opacity", 1);

   
svg.call(zoom); 


var path = d3.geoPath()
	.projection(projection)
	
var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

var info = g6.selectAll("div").append("div")   
.attr("class", "tooltip")               
.style("opacity", 1);

info.append("text").attr("text","asdasdadasd");

ready();

function clicked(d) {

  if (active.node() === this) return reset();
  active.classed("countries", false);
 // active = d3.select("#UNITED STATES OF AMERICA").classed("active",true);
    
  svg.transition()
	  .delay(3000)
      .duration(3000)
      .call( zoom.transform, d3.zoomIdentity.translate(sf[0],sf[1]).scale(2.5) ); // updated for d3 v4
		
  g1.selectAll(".route")
		.transition()
		.duration(450)
		.attr("stroke-dashoffset",  function() { return Math.abs(this.getTotalLength()); })
		.transition().duration(0).remove();
		
}

function reset() {

  active.classed("active", false);
  active = d3.select(null);
 
  svg.transition()
      .duration(750)
      // .call( zoom.transform, d3.zoomIdentity.translate(0, 0).scale(1) ); // not in d3 v4
      .call( zoom.transform, d3.zoomIdentity.translate(0,0).scale(1)); // updated for d3 v4
}

function zoomed() {
  g1.style("stroke-width", 1.5 / d3.event.transform.k + "px");
  // g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")"); // not in d3 v4
  g1.attr("transform", d3.event.transform); // updated for d3 v4
}

// If the drag behavior prevents the default click,
// also stop propagation so we donâ€™t click-to-zoom.
function stopped() {
  if (d3.event.defaultPrevented) d3.event.stopPropagation();
}

function ready(){
	var commodities = ["PAKISTAN","FRANCE","NEPAL","JAPAN","BRAZIL","VENEZUELA","TURKEY","RUSSIA"]
	var commodities2 = ["INDIA","CHINA","S-KOREA","CANADA","MEXICO","PHILIPPINES","UK","TAIWAN"];
	var commodities3 = ["GERMANY","IRAN","VIETNAM","ITALY"]
		 
	d3.json('world-110m.geojson', function(err, geojson) {
		  
		var features=geojson.features
		
		g1.selectAll(".country")
			.data(features)
			.enter().append("path")
			.attr("class", "country")
			.attr("d",path)
			.attr("id",function(d) { return (d.properties.name.toUpperCase()); })
			.on("click", clicked)
			;
	 });	
	 
	 
	d3.csv('top20.csv', function(err, paths) {
		  

		g1.select("#ANTARCTICA").remove()
				 
		g2.selectAll("circle").data(paths).enter().append("circle")
			.attr("r",3)
			.attr("cx", function(d){
				var coords = projection([d.COC_Long,d.COC_Lat]) 
				return coords[0];
			})
			.attr("cy", function(d){
				var coords = projection([d.COC_Long,d.COC_Lat]) 
				return coords[1];
			})
			.attr("class","source-port source")
			.style('opacity',1);		
			
			
		g2.selectAll("text").data(paths).enter().append("text")
			.attr("x",function(d){
			var coords = projection([d.COC_Long,d.COC_Lat]) 
			return coords[0]+15;} )
			.attr("y",function(d){
			var coords = projection([d.COC_Long,d.COC_Lat]) 
			return coords[1]+15;} )
			.attr("text-anchor","middle")
			.text(function(d) { return d.Country; })
			.attr("class","countryLabel")
			.style('opacity',1);
			
			// Add some buttons
		g3.selectAll(".commodityButton")
			.data(commodities2)
			.enter()
			.append("rect")
			.attr("x", function(d,i) { return i * 120 + 40} )
			.attr("y", 20)
			.attr("rx",5).attr("ry",5).attr("width",100).attr("height",40)
			.attr("fill","#e2e6ea").attr("stroke","#999")
			.attr("class","commodityButton")
			.on("click",function(d) {clicked;replaceCountry(d);})
			;
					
		g3.selectAll(".commodityLabel")
			.data(commodities2).enter()
			.append("text")
			.attr("x",function (d,i) { return i * 120 + 90} )
			.attr("y",45)
			.attr("text-anchor","middle")
			.text(function(d) { return d; })
			.attr("class","commodityLabel")
			.on("click",reset())
			.on("click",function(d) { replaceCountry(d);  });
			
			//2 Add some buttons
		g4.selectAll(".commodityButton")
			.data(commodities)
			.enter()
			.append("rect")
			.attr("x", function(d,i) { return i * 120 + 40} )
			.attr("y", 70)
			.attr("rx",5).attr("ry",5).attr("width",100).attr("height",40)
			.attr("fill","#e2e6ea").attr("stroke","#999")
			.attr("class","commodityButton")
			.on("click",function(d) {clicked;replaceCountry(d);})
			;
					
		g4.selectAll(".commodityLabel")
			.data(commodities).enter()
			.append("text")
			.attr("x",function (d,i) { return i * 120 + 90} )
			.attr("y",95)
			.attr("text-anchor","middle")
			.text(function(d) { return d; })
			.attr("class","commodityLabel")
			.on("click",reset())
			.on("click",function(d) { replaceCountry(d);  });	
		// Start with a set of routes
		
		g5.selectAll(".commodityButton")
			.data(commodities3)
			.enter()
			.append("rect")
			.attr("x", function(d,i) { return i * 120 + 40} )
			.attr("y", 120)
			.attr("rx",5).attr("ry",5).attr("width",100).attr("height",40)
			.attr("fill","#e2e6ea")
			.attr("stroke","#999")
			.attr("class","commodityButton")
	 
			.on("click",function(d) {clicked;replaceCountry(d);})
			;
					
		g5.selectAll(".commodityLabel")
			.data(commodities3).enter()
			.append("text")
			.attr("x",function (d,i) { return i * 120 + 90} )
			.attr("y",145)
			.attr("text-anchor","middle")
			.text(function(d) { return d; })
			.attr("class","commodityLabel")
			.on("click",reset())
			.on("click",function(d) { replaceCountry(d);  });	
		// Start with a set of routes
	});
	//drawCountry("INDIA");
	
}

// Draw a set of routes 
var previousSelected;
function drawCountry(country) {
console.log(country);
			 
			
			zoom.transform(svg, d3.zoomIdentity);
			g2.selectAll("circle").transition().style('opacity',1);
			g2.selectAll("text").transition().style('opacity',1);
			
			
			d3.select('#'+ previousSelected).classed('selected',false);
			d3.select('#'+country).classed('selected',true);
			previousSelected=country
			
			
			d3.csv(country + '.csv', function (error, routes) {
			//var maxVolume = d3.max(routes, function(d) { return d.Count; });		
			//var line = d3.line().curve(d3.curveBasis);
			 
			
 
			var TotalCount =0;
			routes.forEach( function(d){
				TotalCount=TotalCount+Number(d.Count);
				 
			})
			 
			routes.forEach( function(d) {
				var bend = lngLatToArc(d, [d.Long,d.Lat],[d.COC_Long,d.COC_Lat], 1);
			 	var routePath = g1.append("path")	
					.attr("d", bend)  
					.attr("class", d.Country.replace(" ", "-") + " " + "route")
					.attr("stroke-opacity", 5)
					.attr("stroke-width", 1 );
				

			var totalLength =  routePath.node().getTotalLength() + 10;
				routePath
					.attr("stroke-dasharray", totalLength + " " + totalLength)
					.attr("stroke-dashoffset", -totalLength)
					.transition()
					.duration(3000)
					.attr("stroke-dashoffset", 0)
					;

			});
			
			
			var b= g1.selectAll("circle").data(routes).enter().append("circle")
					//.transition()
					.style('opacity', 0)
					.attr("cx", function(d){
						var coords = projection([d.Long,d.Lat]) 
						return coords[0];
					})
					.attr("cy", function(d){
						var coords = projection([d.Long,d.Lat]) 
						return coords[1];
					})
					.on("mouseover", function(d) {      
							div.transition()        
								.duration(200)      
								.style("opacity", .9);      
							div.html("Destination City: <b>" + d.City +"</b><br>Application Count: <b>"+ d.Count+ "</b>")  
								.style("left", (d3.event.pageX) + "px")     
								.style("top", (d3.event.pageY - 28) + "px");    
							})                  
					.on("mouseout", function(d) {       
						div.transition()        
							.duration(500)      
							.style("opacity", 0);   
					})
			        .attr("class", "bubble1")
					//.attr("r", function(d){return d.Count/1000;})
					.attr("r", function(d){return (d.Count/TotalCount)*100;})
					.attr("fill", "#00E5FF")
					.transition()
					.delay(1000)
					.duration(2000)
					.style('opacity', 1);
					
				var elementHeight =	50;
				var elementWidth =110;	
				var annotationlines = g1.selectAll(".line")
					.data(routes)
					.enter()
					.append("line")
					.style('opacity',0)
					.attr("x1", function(d){
						var coords = projection([d.Long,d.Lat]) 
						return coords[0];})
						
					.attr("y1", function(d){
						var coords = projection([d.Long,d.Lat]) 
						return coords[1];
					})
					.attr("x2", function(d){
						var coords = projection([-100,d.Lat]) 
						if (Number(d.Long) < -100){return coords[0]-240+elementWidth/2;} else {return coords[0]+180+elementWidth/2;}} )
					.attr("y2", function(d){
						var coords = projection([d.Long,70]) 
						return coords[1]+(d.CityRank*(elementHeight+10))+30+elementHeight/2;
						
					} )
					.attr("stroke-width", 1.5)
					//.attr("stroke", "tomato")
					.attr("stroke-dasharray", 200)
					.attr("stroke-dashoffset",0 )
					.attr("stroke", "url(#svgGradient)")
					.attr("fill", "none")
					.transition()
					.delay(6000)
					.duration(2000)
					.style('opacity',function(d){if (d.CityRank > 3){return 0} else {return 1};})
					;
					
				var annotations = g1.selectAll(".annotationButton")
					.data(routes)
					.enter()
					.append("rect")
					.attr("class","annotationButton")
					.style('opacity',0)
					.attr("x", function(d){
						var coords = projection([-100,d.Lat]) 
						if (Number(d.Long) < -100){return coords[0]-240;} else {return coords[0]+180;}} )
					.attr("y", function(d){
						var coords = projection([d.Long,70]) 
						return coords[1]+(d.CityRank*(elementHeight+10))+30;
						
					} )
					.attr("rx",5).attr("ry",5).attr("width",elementWidth).attr("height",elementHeight)
					.attr("fill","#fff2cf")

					.attr("stroke","red")
					.attr("stroke-width","1px")
					
					.transition()
					.delay(5000)
					.duration(2000)
					.style('opacity',function(d){if (d.CityRank > 3){return 0} else {return 1};})
					;
					
				var annotationtext = g1.selectAll(".annotationLabel")
					.data(routes).enter()
					.append("text")
					.style('opacity',0)
					.attr("class","annotationLabel")
					.attr("dy", ".35em")
					.text(function(d) { 
						return d.City + " is ranked";
					}) 
					
					.attr("x", function(d){
						var coords = projection([-100,d.Lat]) 
						if (Number(d.Long) < -100){return coords[0]-240+5;} else {return coords[0]+180+5;}} )
					.attr("y", function(d){
						var coords = projection([d.Long,70]) 
						return coords[1]+(d.CityRank*(elementHeight+10))+30+10;
						
					} )
					.transition()
					.delay(5000)
					.duration(2000)
					.style('opacity',function(d){if (d.CityRank > 3){return 0} else {return 1};});
					
				g1.selectAll(".annotationLabel")
					.data(routes, function(d) { return d; }).enter()
					.append("text")
					.style('opacity',0)
					.attr("class","annotationLabel")
					.attr("dy", ".35em")
					.attr('text-anchor', 'left')
					.text(function(d){if (d.CityRank==1) {return "the 1st most popular";} 
						if (d.CityRank == 2) {return  "the 2nd most popular";}
						if (d.CityRank==3) {return  "the 3rd most popular";}
						else
							{return "";}})
					.attr("x", function(d){
						var coords = projection([-100,d.Lat]) 
						if (Number(d.Long) < -100){return coords[0]-240+5;} else {return coords[0]+180+5;}} )
					.attr("y", function(d){
						var coords = projection([d.Long,70]) 
						return coords[1]+(d.CityRank*(elementHeight+10))+30+10+10;
						
					} )
					.transition()
					.delay(5000)
					.duration(2000)
					.style('opacity',function(d){if (d.CityRank > 3){return 0} else {return 1};});	
				
				g1.selectAll(".annotationLabel")
					.data(routes, function(d) { return d; }).enter()
					.append("text")
					.style('opacity',0)
					.attr("class","annotationLabel")
					.attr("dy", ".35em")
					.attr('text-anchor', 'left')
					.text(function(d){return "destination for applicants";})
					.attr("x", function(d){
						var coords = projection([-100,d.Lat]) 
						if (Number(d.Long) < -100){return coords[0]-240+5;} else {return coords[0]+180+5;}} )
					.attr("y", function(d){
						var coords = projection([d.Long,70]) 
						return coords[1]+(d.CityRank*(elementHeight+10))+30+10+20;
						
					} )
					.transition()
					.delay(5000)
					.duration(2000)
					.style('opacity',function(d){if (d.CityRank > 3){return 0} else {return 1};});	
				
				g1.selectAll(".annotationLabel")
					.data(routes, function(d) { return d; }).enter()
					.append("text")
					.style('opacity',0)
					.attr("class","annotationLabel")
					.attr("dy", ".35em")
					.attr('text-anchor', 'left')
					.text(function(d){return "from "+country+".";})
					.attr("x", function(d){
						var coords = projection([-100,d.Lat]) 
						if (Number(d.Long) < -100){return coords[0]-240+5;} else {return coords[0]+180+5;}} )
					.attr("y", function(d){
						var coords = projection([d.Long,70]) 
						return coords[1]+(d.CityRank*(elementHeight+10))+30+10+30;
						
					} )
					.transition()
					.delay(5000)
					.duration(2000)
					.style('opacity',function(d){if (d.CityRank > 3){return 0} else {return 1};});	
					
				g1.selectAll(".route")
					.transition()
					.delay(3000)
					.duration(1000)
					.attr("stroke-dashoffset",  function() { return this.getTotalLength(); })
					.transition().duration(0).remove();	
					
					//d3.selectAll(".source-port source").transition().remove();
					g2.selectAll("circle").transition().delay(3000).style('opacity',0);
					g2.selectAll("text").transition().delay(3000).style('opacity',0);
					
					svg.transition()
					  .delay(3000)
					  .duration(4000)
					  .call( zoom.transform, d3.zoomIdentity.translate(sf[0],sf[1]).scale(1.5) ); // updated for d3 v4
		});

		arrangeLabels();
	}	
	
// Replace a commodity			
function replaceCountry(country) {
		
		d3.selectAll(".port").remove();
		d3.selectAll(".port-label").remove();
		d3.selectAll(".bubble1").remove();
		d3.selectAll("line").remove();
		d3.selectAll(".annotationLabel").remove();
		d3.selectAll(".annotationButton").remove();
		
		
		var routes = g1.selectAll(".route")
			.transition()
			.duration(1000)
			.attr("stroke-dashoffset",  function() { return this.getTotalLength(); })
			.transition().duration(0).remove();
		 
		drawCountry(country);	
		clicked(this);
	}	
// Draw ports and labels associated with routes
function drawPorts(d) {

	g2.selectAll("circle").append("circle")
		.attr("cx", function(d){ 
			var coords = projection([d.Long,d.Lat]) 
			return coords[0];
		})
		.attr("cy", function(d){
			var coords = projection([d.Long,d.Lat]) 
			return coords[1];
		})
		.attr("r",4.5)
		.attr("class","port")
		.attr("opacity",0.1)
		.transition().duration(2000)
		.attr("id",d.City.replace(" ", "-")) 
		.attr("opacity",1);
		
	g2.selectAll("text").enter().append("text")
			.attr("x", function(d){
			var coords = projection([d.Long,d.Lat]) 
			return coords[0]+8;
			})
			.attr("y", function(d){console.log(d.Long)
			var coords = projection([d.Long,d.Lat]) 
			return coords[1]+4;
			})
			.text(d.City)
			.attr("opacity",0.1)
			.attr("class","port-label")
			.transition().duration(2000)
			.attr("opacity",1)
			.attr("id",function(d){ return d.City;});	
		
}
	
function lngLatToArc(d, sourceLngLat, targetLngLat, bend){
		// If no bend is supplied, then do the plain square root
		bend = bend || 1;
		// `d[sourceName]` and `d[targetname]` are arrays of `[lng, lat]`
		// Note, people often put these in lat then lng, but mathematically we want x then y which is `lng,lat`

		if (targetLngLat && sourceLngLat) {
			var sourceXY = projection( sourceLngLat ),
					targetXY = projection( targetLngLat );

			// Uncomment this for testing, useful to see if you have any null lng/lat values
			// if (!targetXY) console.log(d, targetLngLat, targetXY)
			var sourceX = sourceXY[0],
					sourceY = sourceXY[1];

			var targetX = targetXY[0],
					targetY = targetXY[1];

			var dx = targetX - sourceX,
					dy = targetY - sourceY,
					dr = Math.sqrt(dx * dx + dy * dy)*bend;

			// To avoid a whirlpool effect, make the bend direction consistent regardless of whether the source is east or west of the target
			var west_of_source = (targetX - sourceX) < 0;
			if (west_of_source) return "M" + targetX + "," + targetY + "A" + dr + "," + dr + " 0 0,1 " + sourceX + "," + sourceY;
			return "M" + sourceX + "," + sourceY + "A" + dr + "," + dr + " 0 0,1 " + targetX + "," + targetY;
			
		} else {
			return "M0,0,l0,0z";
		}
}

function arrangeLabels() {
  var move = 1;
  while(move > 0) {
    move = 0;
 
    g1.selectAll(".annotationLabel")
       .each(function() {
 
         var that = this,
             a = this.getBoundingClientRect();
         g1.selectAll(".annotationLabel")
            .each(function() {
              if(this != that) {
                var b = this.getBoundingClientRect();
                if((Math.abs(a.left - b.left) * 2 < (a.width + b.width)) &&
                   (Math.abs(a.top - b.top) * 2 < (a.height + b.height))) {
                  // overlap, move labels
                  var dx = (Math.max(0, a.right - b.left) +
                           Math.min(0, a.left - b.right)) * 0.01,
                      dy = (Math.max(0, a.bottom - b.top) +
                           Math.min(0, a.top - b.bottom)) * 0.02,
                      tt = d3.transform(d3.select(this).attr("transform")),
                      to = d3.transform(d3.select(that).attr("transform"));
                  move += Math.abs(dx) + Math.abs(dy);
                
                  to.translate = [ to.translate[0] + dx, to.translate[1] + dy ];
                  tt.translate = [ tt.translate[0] - dx, tt.translate[1] - dy ];
                  d3.select(this).attr("transform", "translate(" + tt.translate + ")");
                  d3.select(that).attr("transform", "translate(" + to.translate + ")");
                  a = this.getBoundingClientRect();
                }
              }
            });
       });
  }
}
	
</script>
</body>